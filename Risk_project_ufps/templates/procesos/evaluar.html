{% extends "procesos/plantilla_procesos.html" %}

{% block title %} Proyecto {% endblock %}




{% load static %}
{% block organigrama_up %}
<style type="text/css">
  table, th, td {
    border-top: 1px solid black !important;
    border: 1px solid black;
  }
  td {
    width: 50px !important;
    height: 50px !important;   
  }

</style>
{% endblock %}
{% block content %}
<div class="content-wrapper">
  <div class="container">
    <section class="content-header"  style="margin-top: 70px;">
      <h1>
        {% if proyecto %}
        {{ proyecto.proyecto_nombre }}
        {% endif %}
        <small>Identificar riesgos</small>
      </h1>
      <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Inicio</a></li>
        <li class="active">Proyecto</li>
      </ol>
      {% if mensaje %}
      <div class="callout callout-info">
        <h4>Registro Exitoso</h4>
        {{mensaje}}      
      </div>
      {% endif %}
      {% if mensaje_eliminar %}
      <div class="callout callout-danger">
        <h4>Borrado Exitoso</h4>
          {{mensaje_eliminar}}      
      </div>
      {% endif %}
      {% if mensaje_editar %}
      <div class="callout callout-warning">
        <h4>Actualización Exitosa</h4>
        {{mensaje_editar}}      
      </div>
      {% endif %}
    </section>
    <section class="content">
      <div class="box box-default">
        <div class="box-header with-border">
          <h3 class="box-title">Nombre Proyecto</h3>
        </div>
        <div class="box-body">
          Aqui deberia ir la información del proyecto.
          <a href="/mi_proyecto/{{ proyecto.proyecto_id }}/generar_informe_evaluar/">Generar informe</a>
        </div>
      </div>
            <div class="box box-default">
        <div class="box-header with-border">
          <h3 class="box-title">Nombre Proyecto</h3>
        </div>
        <div class="box-body">
          <table id="example" class="table table-bordered table-striped dataTable" style="width:100%">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>
                      <label data-toggle="tooltip" data-placement="top" title="Consecuencias que puede ocasionar al proyecto la materialización del riesgo">Impacto</label>
                    </th>
                    <th>
                      <label data-toggle="tooltip" data-placement="top" title="Posibilidad de ocurrencia del riesgo">Probabilidad</label>
                    </th>
                    <th>
                      <label data-toggle="tooltip" data-placement="top" title="Resultado de multiplicar probabilidad por impacto.">Nivel</label>
                    </th>
                    <th>
                      <label data-toggle="tooltip" data-placement="top" title="Resultado de multiplicar probabilidad por impacto">Total</label>
                    </th>
                </tr>
            </thead>
            <tbody id="tabla_riesgos">
                
               
            </tbody>
            <tfoot>
                <tr>
                    <th>Nombre</th>
                    <th>
                      <label data-toggle="tooltip" data-placement="bottom" title="Consecuencias que puede ocasionar al proyecto la materialización del riesgo">Impacto</label>
                    </th>
                    <th>
                      <label data-toggle="tooltip" data-placement="bottom" title="Posibilidad de ocurrencia del riesgo">Probabilidad</label>
                    </th>
                    <th>
                      <label data-toggle="tooltip" data-placement="bottom" title="Resultado de multiplicar probabilidad por impacto.">Nivel</label>
                    </th>
                    <th>
                      <label data-toggle="tooltip" data-placement="bottom" title="Resultado de multiplicar probabilidad por impacto">Total</label>
                    </th>
                </tr>
            </tfoot>
        </table>
        </div>
        <div class="box-footer">
          <button class="btn btn-info pull-right" onclick="actualizar_valores();">Confirmar</button>
        </div>
      </div>
      <div class="box box-default">
        <div class="box-body">
          <div class="row justify-content-md-center">
            <div class="col col-lg-2"></div>
            <div class="col-md-8">
              <table class="table">
                <tbody id="matriz_calor">                 
                </tbody>
              </table>
            </div>
            <div class="col col-lg-2"></div>
          </div>
          <div class="row justify-content-md-center">
            <div class="col col-lg-3"></div>
            <div class="col-md-6">
              <table class="table">
                <thead>
                  <tr>
                    <th>
                      Clasificación del Riesgo
                    </th>
                    <th>
                      Rango de P * I
                    </th>
                  </tr>
                </thead>
                <tbody id="tabla_clasificacion_riesgos">     
                  <tr>
                    <td>
                      <div class="input-group my-colorpicker2 colorpicker-element">
                        <div class="input-group-addon" style="background-color:#cdc85c;">
                          <i></i>
                        </div>
                        <div class="form-control" style="border-top: 0px;border-bottom: 0px;border-right: 0px;">
                          <label>dfd</label>
                        </div>
                      </div>
                    </td>
                    <td><label>
                      4-5
                    </label></td>
                  </tr>
                  <tr>
                    <td>dsf</td>
                    <td>sdf</td>
                  </tr>
                  <tr>
                    <td>sdf</td>
                    <td>dsf</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="col col-lg-3"></div>
          </div>
        </div>
      </div>
  </div>
</div>
{% endblock %}
{% block organigrama_down %}
<!-- DataTables -->
<script src="{% static 'risk_project/bower_components/datatables.net/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'risk_project/bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js' %}"></script>

<script type="text/javascript">
  //////////////////////////////////////////
  //  Variables globales
  /////////////////////////////////////////
  var riesgos = JSON.parse("{{lista_riesgos|escapejs}}");   
  console.log(riesgos);

  var rangos_riesgos = JSON.parse("{{rangos|escapejs}}");  

  var valores = JSON.parse("{{valores|escapejs}}");  

  var cambios_riesgos = {};

  const csrftoken = getCookie('csrftoken');

  console.log(rangos_riesgos);
  console.log(valores);

  function construir_matriz_calor(anchura, altura) {
    let matriz_calor = document.getElementById('matriz_calor');
    for (let i = 0; i < altura ; i++) {
      let tr = document.createElement("tr");
      for (let j = 0; j < anchura; j++) {
        tr.appendChild(document.createElement("td"));        
      }
      matriz_calor.appendChild(tr);
    }
  }

  function llenar_matriz_calor(impactos, probabilidades) {
    let matriz_calor = document.getElementById('matriz_calor');
    let anchura = impactos.length;
    let altura = probabilidades.length;
    impactos = ordenarMenoraMayor(impactos);
    probabilidades = ordenarMayoraMenor(probabilidades);

    let filas = matriz_calor.getElementsByTagName("tr");    
    console.log(filas);
    for (let i = 1; i < filas.length; i++) {
      let columnas = filas[i].getElementsByTagName("td");
      for (let j = 1; j < columnas.length; j++) {
        let p = probabilidades[i-1];
        let ii = impactos[j-1];
        columnas[j].appendChild(document.createTextNode("p_"+p));
        columnas[j].appendChild(document.createTextNode("i_"+ii));        
        columnas[j].setAttribute("style", "background-color:"+get_rango(p*ii)+";");
      }
    }   
  }

  function ordenarMenoraMayor(mi_array) {      
    return mi_array.sort(function(a, b){return a-b});
  }

  function ordenarMayoraMenor(mi_array) {      
    return mi_array.sort(function(a, b){return b-a});
  }

  function get_rango(valor){
    color = 0
    n = rangos_riesgos.length
    for (let i = 0; i < n - 1; i++) {
      let rango = rangos_riesgos[i]["rango"];
      if(valor >= rango[0] && valor <= rango[1] ){      
        color = rangos_riesgos[i]["color"];
        break;
      }
    }
    if(color == 0){
      return rangos_riesgos[n-1]["color"];
    }
    return color;
  }

  function construir_select_escalas(tipo, riesgo_id, valores, valor_default){
    let select = document.createElement("select");
    select.setAttribute("id", "select_"+tipo+"_"+riesgo_id);
    select.setAttribute("onchange", "ajustar_evaluacion('"+tipo+"', "+riesgo_id+");")
    for (let i = 0; i < valores.length; i++) {
      let option = document.createElement("option");  
      if(valores[i]["id"] == valor_default){
        option.setAttribute("selected", true);      
      }    
      option.setAttribute("value", valores[i]["id"]);       
      option.appendChild(document.createTextNode(valores[i]["nombre"]));
      select.appendChild(option);
    }
    return select;
  }

  function get_porcentaje(valor) {    
    return ((valor * 100)/25);
  }

  function construir_pogress_bar(valor, riesgo_id) {
    let mi_class = get_rango(valor);
    let div_1 = document.createElement("div");
    let div_1_1 = document.createElement("div");
    div_1_1.setAttribute("id", "barra_"+riesgo_id); 
    div_1.setAttribute("class", "progress progress-xs");
    div_1_1.setAttribute("class", "progress-bar");
    div_1_1.setAttribute("style", "width:"+get_porcentaje(valor)+"%; background-color:"+mi_class+";");
    div_1.appendChild(div_1_1);
    return div_1;                        
  }

  function construir_letrero(valor, riesgo_id){
    let mi_class = get_rango(valor);
    let span = document.createElement("span");
    span.appendChild(document.createTextNode(valor));
    span.setAttribute("id", "letrero_"+riesgo_id);
    span.setAttribute("class", "badge");
    span.setAttribute("style", "background-color:"+mi_class+";")
    return span;
  }

  function construir_tabla_riesgos(){
    let tabla_riesgos = document.getElementById("tabla_riesgos")
    for (let i = 0; i < riesgos.length; i++) {
      let tr = document.createElement("tr");
      
      let td_1 = document.createElement("td");
      let td_2 = document.createElement("td");
      let td_3 = document.createElement("td");
      let td_4 = document.createElement("td");
      let td_5 = document.createElement("td");
      

      td_1.appendChild(document.createTextNode(riesgos[i]["riesgo_nombre"]));
      td_2.appendChild(construir_select_escalas("impacto", riesgos[i]["riesgo_id"], valores["impactos"],riesgos[i]["impacto_id"]));
      td_3.appendChild(construir_select_escalas("probabilidad", riesgos[i]["riesgo_id"], valores["probabilidades"],riesgos[i]["propabilidad_id"]));
      let a = get_valor_impacto_id(riesgos[i]["impacto_id"]);
      let b = get_valor_probabilidad_id(riesgos[i]["propabilidad_id"]);
      let c = a*b;
      td_4.appendChild(construir_pogress_bar(c,riesgos[i]["riesgo_id"]));
      td_5.appendChild(construir_letrero(c,riesgos[i]["riesgo_id"]));

      tr.appendChild(td_1);
      tr.appendChild(td_2);
      tr.appendChild(td_3);
      tr.appendChild(td_4);
      tr.appendChild(td_5);

      tabla_riesgos.appendChild(tr);

    }
    
  }


  function ajustar_evaluacion(tipo, riesgo_id) {    
    let mi_impacto = $("#select_impacto_"+riesgo_id).val();
    let mi_probabilidad = $("#select_probabilidad_"+riesgo_id).val();
    let a = get_valor_impacto_id(mi_impacto)
    let b = get_valor_probabilidad_id(mi_probabilidad);
    let c = a * b;
    let barra = document.getElementById("barra_"+riesgo_id);
    barra.removeAttribute("style")
    barra.setAttribute("style", "width:"+get_porcentaje(c)+"%; background-color:"+get_rango(c)+";");
    let letrero = document.getElementById("letrero_"+riesgo_id);
    letrero.removeAttribute("style");
    letrero.setAttribute("style", "background-color:"+get_rango(c)+";");
    letrero.innerHTML = '';
    letrero.appendChild(document.createTextNode(c));
    if(tipo == "impacto"){
      set_cambios_riesgos(tipo, riesgo_id, c, mi_impacto);
    }else{
      set_cambios_riesgos(tipo, riesgo_id, c, mi_probabilidad);
    }
   
    console.log(cambios_riesgos);
  }

  function set_cambios_riesgos(tipo, riesgo_id, valor_nuevo, id) {
    let key = tipo+"_"+riesgo_id;     
    if(cambios_riesgos.hasOwnProperty(key)){
      cambios_riesgos[key]['valor'] = valor_nuevo;
      cambios_riesgos[key]['id'] = id;
    }else{
      cambios_riesgos[key] = {
        'valor':valor_nuevo,
        'id':id,
        'riesgo':riesgo_id
      }
    }    
  }

  function get_valor_impacto_id(impacto_id) {
    let valor_aux = -1;
    for (let i = 0; i < valores["impactos"].length; i++) {
      if(valores["impactos"][i]["id"] == impacto_id){
        valor_aux = valores["impactos"][i]["escala"];
        break;
      }
    }
    return valor_aux;
  }

  function get_valor_probabilidad_id(probabilidad_id) {
    let valor_aux = -1;
    for (let i = 0; i < valores["probabilidades"].length; i++) {
      if(valores["probabilidades"][i]["id"] == probabilidad_id){
        valor_aux = valores["probabilidades"][i]["escala"];
        break;
      }
    }
    return valor_aux;
  }

  function actualizar_valores() {
    console.log(JSON.stringify(cambios_riesgos));
    $.ajax({
      url: '/mi_proyecto/{{proyecto.proyecto_id}}/evaluar/actualizar_valores/',
      type: 'POST',
      headers: {'X-CSRFToken': csrftoken},
      data: {valores:JSON.stringify(cambios_riesgos)},
      success: function(data) {
          alert("Cambios actualizados exitosamente");
      }, error: function (jqXhr, textStatus, errorMessage) {
        console.log(errorMessage);
        alert("No se pudieron actualizar los cambios");        
      }
    });
  }


  function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
          }
      }
  }
  return cookieValue;
}

function construir_tabla_clasificacion_riesgos(){
  let mi_body_table = document.getElementById("tabla_clasificacion_riesgos");
  mi_body_table.innerHTML = '';
  for (var i = 0; i < rangos_riesgos.length; i++) {
    let template = '<tr><td><div class="input-group my-colorpicker2 colorpicker-element"><div class="input-group-addon" style="background-color:'+rangos_riesgos[i]["color"]+';"><i></i></div><div class="form-control" style="border-top: 0px;border-bottom: 0px;border-right: 0px;"><label>'+rangos_riesgos[i]["nombre"]+'</label></div></div></td><td><label>'+rangos_riesgos[i]["rango"][0]+' - '+rangos_riesgos[i]["rango"][1]+'</label></td></tr>';
    let html = $.parseHTML(template);
    $(mi_body_table).append(html);    
  }
}
  

  $(function() {
    construir_matriz_calor(valores["impactos"].length + 1, valores["probabilidades"].length + 1);
    llenar_matriz_calor(valores["impactos_valores"], valores["probabilidades_valores"]);
    construir_tabla_riesgos(riesgos);
    construir_tabla_clasificacion_riesgos();
    $("#example").DataTable({
     "language": {
         "sProcessing":    "Procesando...",
         "sLengthMenu":    "Mostrar _MENU_ registros",
         "sZeroRecords":   "No se encontraron resultados",
         "sEmptyTable":    "Ningún dato disponible en esta tabla",
         "sInfo":          "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
         "sInfoEmpty":     "Mostrando registros del 0 al 0 de un total de 0 registros",
         "sInfoFiltered":  "(filtrado de un total de _MAX_ registros)",
         "sInfoPostFix":   "",
         "sSearch":        "Buscar:",
         "sUrl":           "",
         "sInfoThousands":  ",",
         "sLoadingRecords": "Cargando...",
         "oPaginate": {
             "sFirst":    "Primero",
             "sLast":    "Último",
             "sNext":    "Siguiente",
             "sPrevious": "Anterior"
         },
         "oAria": {
             "sSortAscending":  ": Activar para ordenar la columna de manera ascendente",
             "sSortDescending": ": Activar para ordenar la columna de manera descendente"
         }
     }
    });

    /*
      Este segmento permite activar los subtitulos para todos los elementos del documento
    */    
    $('[data-toggle="tooltip"]').tooltip();
  });
</script>


{% endblock %}